# 技術的負債解消計画

**作成日**: 2025-07-27  
**現状**: 265/1065 テスト失敗（24.9% 失敗率）

## 🔍 技術的負債の分析

### 1. テスト失敗の分類

#### 高優先度（アーキテクチャ問題）
| カテゴリ | 失敗数 | 主な問題 |
|---------|--------|----------|
| 認証関連 | 3ファイル | CognitoAuthService、LoginForm、RoleGuard |
| モジュール統合 | 1ファイル | モジュール間の依存関係 |
| lyrics-engine | ビルド失敗 | 不適切な依存関係（メインアプリからのインポート） |

#### 中優先度（新機能関連）
| カテゴリ | 失敗数 | 主な問題 |
|---------|--------|----------|
| WebGPU | 2ファイル | Node.js環境での制限 |
| AI機能 | 3ファイル | モック不足、TensorFlow.js関連 |
| iOS検出 | 1ファイル | ブラウザAPI依存 |

#### 低優先度（ユーティリティ）
| カテゴリ | 失敗数 | 主な問題 |
|---------|--------|----------|
| 動的インポート | 2ファイル | global.document再定義エラー |
| エラーハンドリング | 1ファイル | console.errorモックの問題 |
| その他ユーティリティ | 7ファイル | 様々な小規模な問題 |

## 📊 根本原因分析

### 1. **モジュール設計の問題**
- lyrics-engineが主アプリケーションに依存
- モジュール間の境界が不明確
- 共通コンポーネントの重複

### 2. **テスト環境の問題**
- ブラウザAPI（WebGPU、document）のモック不足
- console.errorの過度なモック
- グローバルオブジェクトの再定義エラー

### 3. **型定義の問題**
- CognitoAuthServiceのエクスポート問題
- 認証関連の型不一致
- APIレスポンスの型定義不足

### 4. **CI/CD設定の問題**
- Node.js v18→v20への移行不完全
- 環境変数の設定不足
- テスト実行順序の問題

## 🎯 解消計画

### Phase 1: 即座の修正（1-2日）
1. **テスト環境の修正**
   - グローバルオブジェクトのモック修正
   - console.errorモックの改善
   - ブラウザAPIの適切なモック

2. **認証モジュールの修正**
   - CognitoAuthServiceのエクスポート修正
   - 型定義の統一
   - テストの安定化

### Phase 2: アーキテクチャ改善（3-5日）
1. **lyrics-engineモジュールのリファクタリング**
   - 依存関係の逆転
   - インターフェースの定義
   - 独立したコンポーネント化

2. **共通コンポーネントの抽出**
   - UI共通コンポーネントの専用パッケージ化
   - 型定義の共有
   - テストユーティリティの共有

### Phase 3: 長期的改善（1-2週間）
1. **テストカバレッジの向上**
   - E2Eテストの拡充
   - ビジュアルリグレッションテスト
   - パフォーマンステスト

2. **CI/CDパイプラインの最適化**
   - テストの並列実行
   - キャッシュの最適化
   - デプロイメントの自動化

## 🚀 実装アプローチ

### 新規ブランチ戦略
```
fix/technical-debt-cleanup
├── fix/test-environment
├── fix/auth-module
├── fix/lyrics-engine-refactor
└── fix/ci-optimization
```

### 成功指標
- ✅ テスト成功率 95%以上
- ✅ CI実行時間 5分以内
- ✅ モジュール間の依存関係明確化
- ✅ 型エラー0件

## 📋 タスクリスト

### 即座に対応すべきタスク
- [ ] グローバルオブジェクトモックの修正
- [ ] CognitoAuthServiceエクスポートの修正
- [ ] console.errorモックの改善
- [ ] lyrics-engine依存関係の切り離し

### 中期的タスク
- [ ] 共通UIコンポーネントパッケージの作成
- [ ] 認証モジュールの型定義統一
- [ ] WebGPUテストのスキップ設定
- [ ] AI機能のモック改善

### 長期的タスク
- [ ] E2Eテストカバレッジ向上
- [ ] ビジュアルリグレッションテスト導入
- [ ] CI/CDパイプライン最適化
- [ ] ドキュメント整備

## 🔧 推奨ツール・技術

1. **テスト改善**
   - jest-environment-jsdom-global
   - @testing-library/jest-dom
   - MSW (Mock Service Worker)

2. **型安全性**
   - strict TypeScript設定
   - ESLint stricter rules
   - type-fest utilities

3. **CI/CD**
   - GitHub Actions matrix builds
   - Turborepo for monorepo caching
   - Codecov for coverage tracking

## 📈 期待される成果

1. **開発効率の向上**
   - テスト実行時間50%削減
   - false positiveの排除
   - 信頼性の高いCI/CD

2. **コード品質の向上**
   - 型安全性の確保
   - モジュール間の明確な境界
   - 保守性の向上

3. **チーム生産性**
   - 新機能開発の加速
   - バグの早期発見
   - リファクタリングの容易化